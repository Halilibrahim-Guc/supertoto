<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Futbol Simülasyonu V2</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #27ae60; font-family: 'Arial', sans-serif; }
        
        /* Arayüz */
        #ui-layer {
            position: absolute; top: 20px; width: 100%; text-align: center;
            color: white; pointer-events: none; z-index: 10;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .score-box {
            display: inline-block; padding: 10px 20px; border-radius: 10px;
            text-align: center; vertical-align: middle;
        }
        
        #timer-circle {
            background: #f1c40f; color: black; width: 50px; height: 50px;
            line-height: 50px; border-radius: 50%; font-size: 24px; font-weight: bold;
            display: inline-block; margin: 0 15px; border: 3px solid #fff;
        }

        /* Bitiş Ekranı */
        #end-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); flex-direction: column;
            align-items: center; justify-content: center; color: white; z-index: 20;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="score-box" style="background:#e74c3c;">
            <div style="font-size:14px;">MONACO</div>
            <div id="score-mon" style="font-size:30px; font-weight:bold;">0</div>
        </div>
        
        <div id="timer-circle">9</div>
        
        <div class="score-box" style="background:#c0392b;">
            <div style="font-size:14px;">GALATASARAY</div>
            <div id="score-gs" style="font-size:30px; font-weight:bold;">0</div>
        </div>
    </div>

    <div id="end-screen">
        <h1 style="font-size: 40px; margin: 0;">MAÇ SONUCU</h1>
        <div style="font-size: 80px; font-weight: bold; margin: 20px 0;" id="final-score">0 - 0</div>
        <div style="font-size: 30px; color: #f1c40f;" id="winner-text">...</div>
        <button onclick="location.reload()" style="margin-top:30px; padding:15px 50px; font-size:22px; cursor:pointer; background:white; border:none; border-radius:50px; color:#27ae60; font-weight:bold;">TEKRAR OYNA</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script>
        // --- RESİMLERİ ÖNCEDEN YÜKLE ---
        const imgMon = new Image(); imgMon.src = 'monacofc.png';
        const imgGS = new Image(); imgGS.src = 'gs.png';

        // --- 1. MOTOR KURULUMU ---
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              Body = Matter.Body,
              Vector = Matter.Vector;

        const engine = Engine.create();
        const world = engine.world;
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Yerçekimi ayarı
        engine.gravity.y = 0.9;

        const render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: '#27ae60' // Çim rengi
            }
        });

        // --- 2. SAHNE TASARIMI ---

        // Duvarlar
        const ground = Bodies.rectangle(width/2, height + 60, width, 100, { isStatic: true, render: {fillStyle:'#2ecc71'} });
        const leftWall = Bodies.rectangle(-20, height/2, 40, height * 2, { isStatic: true });
        const rightWall = Bodies.rectangle(width+20, height/2, 40, height * 2, { isStatic: true });

        // Kale Direkleri (Biraz daralttık ki dışarı kaçabilsin)
        const goalWidth = 220; 
        const postHeight = 160;
        const postY = height - (postHeight/2);

        const leftPost = Bodies.rectangle((width/2) - (goalWidth/2), postY, 15, postHeight, { 
            isStatic: true, render: { fillStyle: 'white' } 
        });
        const rightPost = Bodies.rectangle((width/2) + (goalWidth/2), postY, 15, postHeight, { 
            isStatic: true, render: { fillStyle: 'white' } 
        });

        // GOL SENSÖRÜ (Kalenin Ağzında!)
        // Top buna değdiği an gol sayılır.
        const sensorY = height - postHeight + 20; // Direklerin üst hizasına yakın
        const goalSensor = Bodies.rectangle(width/2, sensorY, goalWidth - 20, 10, { 
            isStatic: true, 
            isSensor: true, // Fiziksel engel değil, hayalet çizgi
            label: "GoalSensor",
            render: { fillStyle: 'rgba(255, 255, 255, 0.2)' } 
        });

        // Engeller (Piramit) - Merkezi Hizalı
        const pins = [];
        const startY = 180;
        const rows = 6;
        
        for (let r = 0; r < rows; r++) {
            let pinsInRow = 3 + r; 
            let spacing = 55;
            let rowWidth = (pinsInRow - 1) * spacing;
            let startX = (width / 2) - (rowWidth / 2);

            for (let c = 0; c < pinsInRow; c++) {
                let x = startX + (c * spacing);
                let y = startY + (r * 55);
                if (r % 2 === 0) x += 0; // Hizayı bozma

                pins.push(Bodies.circle(x, y, 5, { 
                    isStatic: true,
                    render: { fillStyle: 'white' },
                    restitution: 0.8 
                }));
            }
        }

        // Hızlı Kaleci
        const goalie = Bodies.circle(width/2, height - 100, 22, { 
            isStatic: true, // Kinematik (kodla hareket)
            label: "Goalie",
            render: { fillStyle: '#ecf0f1', strokeStyle: '#333', lineWidth: 4 } 
        });

        Composite.add(world, [ground, leftWall, rightWall, leftPost, rightPost, goalSensor, goalie, ...pins]);

        // --- 3. MANTIK VE FİZİK ---

        // Kaleci Kontrolü (Daha Hızlı)
        let gSpeed = 9; // HIZ ARTIRILDI
        let gDir = 1;
        let gRange = (goalWidth / 2) - 30;

        Events.on(engine, 'beforeUpdate', () => {
            const px = goalie.position.x;
            if (px > (width/2 + gRange)) gDir = -1;
            if (px < (width/2 - gRange)) gDir = 1;
            
            // Kaleciyi elle hareket ettir
            Body.setPosition(goalie, { x: px + (gSpeed * gDir), y: goalie.position.y });
        });

        // Skor Sistemi
        let scoreM = 0;
        let scoreG = 0;
        let countedBalls = []; // Sayılan topların ID'sini tut

        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach((pair) => {
                const bodyA = pair.bodyA;
                const bodyB = pair.bodyB;

                // 1. Kaleci Vuruşu (Sertleştirildi)
                let ball = null;
                if (bodyA.label === "Goalie" && bodyB.label.includes("Ball")) ball = bodyB;
                if (bodyB.label === "Goalie" && bodyA.label.includes("Ball")) ball = bodyA;

                if (ball) {
                    // Kaleci topa yukarı doğru çok sert vurur
                    Body.applyForce(ball, ball.position, { 
                        x: (Math.random() - 0.5) * 0.15 + (gDir * 0.05), // Yanlara dağıt
                        y: -0.15 // Yukarı çok sert
                    });
                }

                // 2. Gol Kontrolü
                let scoringBall = null;
                if (bodyA.label === "GoalSensor" && bodyB.label.includes("Ball")) scoringBall = bodyB;
                if (bodyB.label === "GoalSensor" && bodyA.label.includes("Ball")) scoringBall = bodyA;

                if (scoringBall && !countedBalls.includes(scoringBall.id)) {
                    countedBalls.push(scoringBall.id); // Bu topu artık saydık
                    
                    if (scoringBall.label === "Ball_MON") {
                        scoreM++;
                        document.getElementById('score-mon').innerText = scoreM;
                        scoringBall.render.strokeStyle = "#e74c3c"; // Gol olunca çerçeve yap
                        scoringBall.render.lineWidth = 3;
                    } else if (scoringBall.label === "Ball_GS") {
                        scoreG++;
                        document.getElementById('score-gs').innerText = scoreG;
                        scoringBall.render.strokeStyle = "#c0392b";
                        scoringBall.render.lineWidth = 3;
                    }
                }
            });
        });

        // --- 4. ÖZEL GÖRSEL ÇİZİMİ (BEYAZ TOP + LOGO) ---
        
        Events.on(render, 'afterRender', function() {
            const context = render.context;
            const bodies = Composite.allBodies(world);

            bodies.forEach(function(body) {
                // Sadece toplar için çizim yap
                if (body.label.includes("Ball")) {
                    const radius = body.circleRadius;
                    const texture = (body.label === "Ball_MON") ? imgMon : imgGS;
                    
                    // Resim yüklenmişse çiz
                    if (texture.complete) {
                        context.save();
                        context.translate(body.position.x, body.position.y);
                        context.rotate(body.angle);
                        
                        // Önce beyaz yuvarlak zaten çizili (render.fillStyle sayesinde)
                        // Şimdi resmi ortaya küçük bir logo gibi çizelim
                        const iconSize = radius * 1.5; // Topun %75'i kadar logo
                        context.drawImage(texture, -iconSize/2, -iconSize/2, iconSize, iconSize);
                        
                        context.restore();
                    }
                }
            });
        });

        // --- 5. OYUN AKIŞI ---

        let ballsRemaining = 9; 

        function spawnBalls() {
            if (ballsRemaining <= 0) {
                finishGame();
                return;
            }

            const r = 20; // Top yarıçapı
            
            // Monaco Topu (Beyaz Zemin)
            // Spawn aralığını genişlettik (width/2 +/- 80)
            let ballMon = Bodies.circle((width/2) - 60 + Math.random()*20, 50, r, {
                restitution: 0.6,
                friction: 0.005,
                label: "Ball_MON",
                render: { fillStyle: '#ffffff' } // Bembeyaz top
            });

            // GS Topu (Beyaz Zemin)
            let ballGS = Bodies.circle((width/2) + 60 - Math.random()*20, 50, r, {
                restitution: 0.6,
                friction: 0.005,
                label: "Ball_GS",
                render: { fillStyle: '#ffffff' } // Bembeyaz top
            });

            Composite.add(world, [ballMon, ballGS]);
            
            ballsRemaining--;
            document.getElementById('timer-circle').innerText = ballsRemaining;
        }

        function finishGame() {
            setTimeout(() => {
                document.getElementById('end-screen').style.display = 'flex';
                document.getElementById('final-score').innerText = scoreM + " - " + scoreG;
                
                const wText = document.getElementById('winner-text');
                if (scoreG > scoreM) wText.innerText = "GALATASARAY KAZANDI!";
                else if (scoreM > scoreG) wText.innerText = "MONACO KAZANDI!";
                else wText.innerText = "BERABERE!";
                
            }, 6000);
        }

        // Başlat
        Render.run(render);
        Runner.run(Runner.create(), engine);
        setInterval(spawnBalls, 1300); // 1.3 saniyede bir

    </script>
</body>
</html>